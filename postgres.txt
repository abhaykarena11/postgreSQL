SELECT COUNT(category_id) AS categories_count , service_type_name 
FROM hc.categories AS c INNER JOIN hc.service_types AS s
ON c.service_type_id = s.service_type_id
GROUP BY service_type_name;


SELECT COUNT(sub_category_id) AS sub_categories_count , category_name
FROM hc.sub_categories AS sc INNER JOIN hc.categories AS c
ON sc.category_id = c.category_id 
GROUP BY category_name;

2. GROUP BY & HAVING 

SELECT COUNT(user_id) AS user_count , role_name
FROM hc.users AS u RIGHT JOIN hc.roles AS r
ON u.role_id = r.role_id
GROUP BY role_name;

SELECT COUNT(user_id) AS user_count , role_name
FROM hc.users AS u RIGHT JOIN hc.roles AS r
ON u.role_id = r.role_id
GROUP BY role_name
HAVING COUNT(user_id) > 2;

SELECT COUNT(category_id) AS categories_count , service_type_name 
FROM hc.categories AS c INNER JOIN hc.service_types AS s
ON c.service_type_id = s.service_type_id
GROUP BY service_type_name
HAVING COUNT(category_id) > 2;

SELECT COUNT(sub_category_id) AS sub_categories_count , category_name
FROM hc.sub_categories AS sc INNER JOIN hc.categories AS c
ON sc.category_id = c.category_id 
GROUP BY category_name
HAVING COUNT(sub_category_id) >= 2;

SELECT COUNT(user_id) AS users_count , EXTRACT(YEAR FROM u.birth_date) AS birth_year
FROM hc.users AS u
GROUP BY EXTRACT(YEAR FROM u.birth_date);

SELECT COUNT(user_id) AS users_count , EXTRACT(YEAR FROM u.birth_date) AS birth_year
FROM hc.users AS u
GROUP BY EXTRACT(YEAR FROM u.birth_date)
HAVING COUNT(user_id) > 5;



--3. Joins
SELECT  service_type_name , category_name 
FROM hc.service_types AS s INNER JOIN hc.categories AS c  
ON c.service_type_id = s.service_type_id;


SELECT service_type_name , category_name  
FROM hc.service_types AS s LEFT JOIN hc.categories AS c  
ON c.service_type_id = s.service_type_id;

SELECT category_name , sub_category_name
FROM hc.sub_categories AS sc RIGHT JOIN hc.categories AS c
ON sc.category_id = c.category_id;



4. EXISTS 

SELECT role_name
FROM hc.roles AS r
WHERE EXISTS 
( SELECT 1
FROM hc.users AS u 
WHERE u.role_id = r.role_id
);


SELECT service_type_name
FROM hc.service_types AS st
WHERE EXISTS
(
SELECT 1
FROM hc.categories AS c
WHERE st.service_type_id = c.service_type_id
);


SELECT category_name
FROM hc.categories AS c
WHERE EXISTS 
(
SELECT 1
FROM hc.sub_categories AS sc
WHERE sc.category_id = c.category_id
);


SELECT (first_name || ' ' || last_name) AS full_name
FROM hc.users AS u
WHERE EXISTS 
(
SELECT 1
FROM hc.roles AS r
WHERE r.role_id = u.role_id
);


-- 5. Common Table Expression (CTE)

ALTER TABLE hc.users
ADD CONSTRAINT fk_users_roles
FOREIGN KEY (role_id)
REFERENCES hc.roles(role_id);

WITH service_type_list AS(
SELECT c.service_type_id , service_type_name
FROM hc.categories AS c
INNER JOIN hc.service_types AS st
ON c.service_type_id = st.service_type_id
)
SELECT COUNT(service_type_id) AS categories_count , service_type_name
FROM service_type_list
GROUP BY service_type_name;


-- 6. Constraints


ALTER TABLE hc.users
ADD CONSTRAINT chk_birth_date_past
CHECK (birth_date < CURRENT_DATE);

ALTER TABLE hc.users
ADD CONSTRAINT chk_mobile_length
CHECK (LENGTH(mobile_number) = 10);


--7. Indexes

CREATE INDEX idx_users_email
ON hc.users (email);


-- 8. Date & Time Handling

SELECT *
FROM hc.users
WHERE created_date::date = CURRENT_DATE;


SELECT *
FROM hc.users
WHERE created_date < CURRENT_DATE + INTERVAL '1 day'
 AND created_date >= CURRENT_DATE - INTERVAL '30 day';


SELECT EXTRACT(YEAR FROM birth_date) AS birth_year 
FROM hc.users AS u;

SELECT * , (ROUND(EXTRACT(EPOCH FROM AGE(CURRENT_DATE,birth_date)) / 86400 / 365.25) , 2) AS age 
FROM hc.users ;


SELECT COUNT(user_id) AS users_count , EXTRACT(YEAR FROM birth_date) AS birth_year
FROM hc.users AS u
GROUP BY EXTRACT(YEAR FROM birth_date);

-- 9. Window Functions (ROW_NUMBER, RANK, LAG, LEAD)

SELECT * , rank() over (PARTITION BY role_id ORDER BY created_date) AS rank
FROM hc.users;

WITH list AS(
SELECT COUNT(user_id) AS users_count , role_name
FROM hc.roles AS r
INNER JOIN hc.users AS u
ON r.role_id = u.role_id
GROUP BY role_name
)
SELECT role_name , RANK() OVER (ORDER BY users_count)
FROM list;

SELECT * , created_date , LAG(created_date) OVER (PARTITION BY role_id ORDER BY created_date) AS previous_user_created_date
FROM hc.users;

WITH list AS (SELECT * , RANK() OVER (PARTITION BY role_id ORDER BY birth_date) AS rank
FROM hc.users)
SELECT * FROM list WHERE rank = 2;

